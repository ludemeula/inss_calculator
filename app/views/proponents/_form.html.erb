<%= form_with model: proponent, local: true, class: "needs-validation" do |form| %>
  <div class="mb-3">
    <%= form.label :name, 'Nome', class: 'form-label' %>
    <%= form.text_field :name, class: 'form-control', required: true %>
  </div>

  <div class="mb-3">
    <%= form.label :documents, 'Documento', class: 'form-label' %>
    <%= form.text_field :documents, class: 'form-control', required: true %>
  </div>

  <div class="mb-3">
    <%= form.label :salary, 'Salário (R$)', class: 'form-label' %>
    <%=
      form.number_field :salary,
                        step: 0.01,
                        class: 'form-control',
                        id: 'salary-input'
    %>
  </div>

  <%= form.fields_for :addresses do |address_fields| %>
    <div class="mb-3">
      <%= address_fields.label :street, 'Logradouro' %>
      <%= address_fields.text_field :street, class: 'form-control' %>
    </div>

    <div class="mb-3">
      <%= address_fields.label :number, 'Número' %>
      <%= address_fields.text_field :number, class: 'form-control' %>
    </div>
  <% end %>

  <h5>Contatos</h5>
  <div id="contacts-wrapper">
    <!-- Contatos existentes -->
    <%= form.fields_for :contacts do |contact_fields| %>
      <%= render 'contact_fields', f: contact_fields %>
    <% end %>
  </div>

  <button type="button" id="add-contact" class="btn btn-outline-primary mb-3">Adicionar Contato</button>


  <div class="mb-3">
    <%= form.label :inss_discount, 'Desconto INSS (R$)', class: 'form-label' %>
    <%=
      form.text_field :inss_discount,
                      class: 'form-control',
                      readonly: true,
                      id: 'inss-field'
    %>
  </div>

  <div class="d-flex justify-content-between">
    <%=
      link_to(
        'Cancelar',
        proponent.persisted? ? proponent_path(proponent) : proponents_path,
        class: 'btn btn-secondary',
      )
    %>
    <%=
      form.submit(
        proponent.persisted? ? 'Atualizar' : 'Salvar',
        class: "btn btn-#{proponent.persisted? ? 'warning' : 'primary'}",
      )
    %>
  </div>
<% end %>

<!-- Template oculto para novos contatos -->
<template id="contact-template">
  <div class="contact-fields mb-3">
    <div class="row g-2">
      <div class="col-md-4">
        <label for="">Tipo</label>
        <select name="proponent[contacts_attributes][INDEX][contact_type]" class="form-select">
          <option>Celular</option>
          <option>WhatsApp</option>
          <option>Email</option>
        </select>
      </div>
      <div class="col-md-6">
        <label for="">Contato</label>
        <input type="text" name="proponent[contacts_attributes][INDEX][value]" class="form-control" />
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-danger remove-contact">Remover</button>
      </div>
    </div>
  </div>
</template>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const wrapper = document.getElementById("contacts-wrapper");
    const template = document.getElementById("contact-template").innerHTML;
    let index = document.querySelectorAll(".contact-fields").length;

    document.getElementById("add-contact").addEventListener("click", () => {
      const newField = template.replace(/INDEX/g, index);
      wrapper.insertAdjacentHTML("beforeend", newField);
      index++;
    });

    wrapper.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-contact")) {
        e.target.closest(".contact-fields").remove();
      }
    });
  });
</script>